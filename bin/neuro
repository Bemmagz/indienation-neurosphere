#!/bin/bash

# --- CONFIGURATION ---
ROOT_DIR="/data/data/com.termux/files/home/indienation-neurosphere"
PY_FILE="$ROOT_DIR/core/neurosphere_guard_node.py"
LOG_FILE="$ROOT_DIR/state/node.log"
LEDGER="$ROOT_DIR/state/ledger.json"
KARMA_FILE="$ROOT_DIR/state/karma.jsonl"
ID_VAULT="$ROOT_DIR/identity_vault.json"

NC='\033[0m'
COL_AURA='\033[0;36m'
COL_GOLD='\033[1;33m'
COL_GREEN='\033[0;32m'

case "$1" in
    up)
        echo -e "\033[0;35m[SYSTEM] Booting Sovereign Guard Node...\033[0m"
        pkill -f "neurosphere_guard_node.py" > /dev/null 2>&1
        sleep 1
        nohup bash -c "
        while true; do
            PORT=5002
            while lsof -i :\$PORT >/dev/null 2>&1; do PORT=\$((PORT + 1)); done
            export PORT=\$PORT
            python3 \"$PY_FILE\" >> \"$LOG_FILE\" 2>&1
            sleep 2
        done" > /dev/null 2>&1 &
        echo -e "${COL_GREEN}[SUCCESS] Node is now active in background.${NC}"
        ;;

    top)
        while true; do
            clear
            POINTS=$(jq -s 'map(.points) | add' "$KARMA_FILE" 2>/dev/null || echo 0)
            BAL_ENPE=$(grep -o "ENPE" "$LEDGER" | wc -l | awk '{print $1 * 100}')
            BAL_LUV=$(grep -o "LUV" "$LEDGER" | wc -l | awk '{print $1 * 5}')
            [ "$POINTS" -ge 50 ] && AURA="GOLDEN RADIANCE" || AURA="CYAN STEADY"
            
            echo -e "${COL_AURA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "  NEUROSPHERE REAL-TIME DASHBOARD          [ v1.0-STABLE ]"
            echo -e "${COL_AURA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "  NODE ID      : NeuroID#001"
            echo -e "  AURA STATUS  : $AURA"
            echo -e "  KARMA POINTS : ${COL_GREEN}${POINTS} Pts${NC}"
            echo -e "  TOTAL TM     : $((BAL_ENPE + BAL_LUV)) units (ENPE:$BAL_ENPE | LUV:$BAL_LUV)"
            echo -e "${COL_AURA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "  LATEST PULSE:"
            tail -n 2 "$LOG_FILE" 2>/dev/null | cut -c1-60
            echo -e "${COL_AURA}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "  [ CTRL+C to Exit ]"
            sleep 2
        done
        ;;

    scan)
        LOCAL_IP=$(ifconfig wlan0 2>/dev/null | grep "inet " | awk '{print $2}')
        [ -z "$LOCAL_IP" ] && LOCAL_IP=$(hostname -I | awk '{print $1}')
        PREFIX=$(echo $LOCAL_IP | cut -d. -f1-3)
        echo -e "\033[0;35mðŸ“¡ Scanning & Syncing Aura in $PREFIX.0/24...\033[0m"
        for i in {1..254}; do
            (
                target="$PREFIX.$i"
                if curl -s -m 0.5 "http://$target:5002/" | grep -q "NeuroSphere" 2>/dev/null; then
                    echo -e "${COL_GREEN}[FOUND] Node at $target. Sending Handshake...${NC}"
                    curl -s -X POST "http://$target:5002/transfer" -H "Content-Type: application/json" \
                    -d '{"sender":"NeuroID#001","recipient":"PEER_SYNC","asset":"HANDSHAKE_AURA"}' > /dev/null 2>&1
                fi
            ) &
        done
        wait
        ;;

    backup)
        /data/data/com.termux/files/home/indienation-neurosphere/bin/neuro_backup.sh
        ;;
    qr)
        python3 -c "import qrcode, json; data=json.load(open('$ID_VAULT')); qr=qrcode.QRCode(box_size=1, border=2); qr.add_data(json.dumps({'id':data['user_id'],'aura':data['aura_status']})); qr.print_ascii(invert=True)"
        ;;

    donate)
        AMT=${2:-0}
        TS=$(date +"%Y-%m-%d %H:%M:%S")
        echo "{\"timestamp\": \"$TS\", \"type\": \"DONATION\", \"asset\": \"ENPE\", \"amount\": $AMT, \"tag\": \"15_PERCENT_POOL\"}" >> "$LEDGER"
        echo -e "${COL_GREEN}[HEART] $AMT ENPE allocated to Emergency Pool.${NC}"
        ;;

    status)
        pgrep -f "neurosphere_guard_node.py" > /dev/null && echo -e "Node: ${COL_GREEN}ONLINE${NC}" || echo -e "Node: \033[0;31mOFFLINE\033[0m"
        ;;

    *)
        echo "Usage: neuro {up|top|scan|qr|donate|status}"
        ;;
esac
