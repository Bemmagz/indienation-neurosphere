#!/data/data/com.termux/files/usr/bin/bash

# NeuroSphere Unified CLI v4.3.0
VERSION="4.3.0"
DB_FILE="neurosphere.db"
OLD_SCRIPT="neuro-old"

# Colors for Auralang
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
RED='\033[0;31m'
BLUE='\033[0;34m'
PURPLE='\033[0;95m'
NC='\033[0m'

# Header function
header() {
    echo -e "${CYAN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${CYAN}‚ïë            NEUROSPHERE SOVEREIGN SYSTEM v${VERSION}            ‚ïë${NC}"
    echo -e "${CYAN}‚ïë               QR-Verified Auralang Protocol               ‚ïë${NC}"
    echo -e "${CYAN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# QR code generation function
generate_qr_terminal() {
    local id="$1"
    local aura="$2"
    local status="$3"
    
    echo -e "${YELLOW}üîó Generating shareable QR code for ${id}...${NC}"
    
    # Create a simple ASCII QR-like representation
    local qr_data="neurosphere://citizen/${id}"
    echo -e "${CYAN}‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${CYAN}‚îÇ          NeuroSphere Citizen QR Data               ‚îÇ${NC}"
    echo -e "${CYAN}‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§${NC}"
    echo -e "‚îÇ ${GREEN}ID:${NC} $id"
    echo -e "‚îÇ ${GREEN}Aura:${NC} $aura"
    echo -e "‚îÇ ${GREEN}Status:${NC} $status"
    echo -e "‚îÇ ${GREEN}URL:${NC} $qr_data"
    echo -e "${CYAN}‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo -e "${YELLOW}üì± Scan QR code in avatar to verify this data${NC}"
}

# Main command handler
case "$1" in
    recover)
        ./ns-recovery.sh "$2" "$3"
        ;;
    tree)
        python neuro-tree.py
        ;;
    verify)
        ./neuro-lineage.sh find "$2"
        ;;
    nft|avatar|visualize)
        header
        echo -e "${PURPLE}üé® NeuroSphere NFT Avatar Generator v4.3.0${NC}"
        echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
        
        if [ ! -f "neuro-gen.py" ]; then
            echo -e "${RED}‚ùå neuro-gen.py not found!${NC}"
            echo "Please ensure the avatar generator script is in the current directory."
            exit 1
        fi
        
        echo -e "${YELLOW}Generating NFT-style avatars with QR codes...${NC}"
        echo ""
        
        # Run the Python generator
        python3 neuro-gen.py
        
        if [ $? -eq 0 ]; then
            echo ""
            echo -e "${GREEN}‚ú® Avatar generation complete!${NC}"
            echo ""
            echo -e "${CYAN}üìÇ Files generated in:${NC} ./avatars/"
            echo -e "${CYAN}üåê View gallery:${NC}      file://$(pwd)/avatars/index.html"
            echo -e "${CYAN}üì± Scan QR codes:${NC}     Open any .svg file and scan the QR code"
            echo ""
            echo -e "${YELLOW}To view in Termux:${NC}"
            echo "  termux-open avatars/index.html"
        else
            echo -e "${RED}‚ùå Avatar generation failed!${NC}"
        fi
        ;;
    
    qr|code)
        header
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: ns qr [citizen_id]${NC}"
            echo -e "${YELLOW}Example: ns qr Heir_Successor_99${NC}"
            exit 1
        fi
        
        # Get citizen data
        DATA=$(sqlite3 "$DB_FILE" "SELECT id, CAST(current_aura * 0.9 AS INTEGER), status FROM citizens WHERE id='$2';" 2>/dev/null)
        
        if [ -z "$DATA" ]; then
            echo -e "${RED}‚ùå Citizen '$2' not found!${NC}"
            exit 1
        fi
        
        IFS='|' read -r id aura status <<< "$DATA"
        
        echo -e "${MAGENTA}üîç QR Data for Citizen: $id${NC}"
        echo ""
        
        # Generate terminal QR display
        generate_qr_terminal "$id" "$aura" "$status"
        
        # Check if avatar exists
        if [ -f "avatars/${id// /_}.svg" ]; then
            echo ""
            echo -e "${GREEN}‚úÖ Avatar exists:${NC} avatars/${id// /_}.svg"
            echo -e "${CYAN}Scan the QR code in the avatar to verify authenticity.${NC}"
        else
            echo ""
            echo -e "${YELLOW}‚ö†Ô∏è No avatar found. Generate one with:${NC}"
            echo "  ns nft"
        fi
        ;;
    
    gallery|collection)
        header
        if [ -d "avatars" ] && [ -f "avatars/index.html" ]; then
            echo -e "${PURPLE}üñºÔ∏è NeuroSphere Sovereign Collection${NC}"
            echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
            
            COUNT=$(find avatars -name "*.svg" | wc -l)
            echo -e "${GREEN}Found ${COUNT} avatars in the collection${NC}"
            echo ""
            
            # Show some stats
            SEED_COUNT=$(find avatars -name "*.svg" -exec grep -l "#00ff00" {} \; | wc -l)
            GUARDIAN_COUNT=$(find avatars -name "*.svg" -exec grep -l "#00ffff" {} \; | wc -l)
            LEGEND_COUNT=$(find avatars -name "*.svg" -exec grep -l "#ff00ff" {} \; | wc -l)
            
            echo -e "${GREEN}üå± Seeds:${NC} $SEED_COUNT"
            echo -e "${CYAN}üõ°Ô∏è Guardians:${NC} $GUARDIAN_COUNT"
            echo -e "${MAGENTA}üëë Legends:${NC} $LEGEND_COUNT"
            echo ""
            
            # List recent avatars
            echo -e "${YELLOW}Recent avatars:${NC}"
            ls -1t avatars/*.svg 2>/dev/null | head -5 | while read file; do
                name=$(basename "$file" .svg)
                echo "  üé® $name"
            done
            
            echo ""
            echo -e "${CYAN}To view in browser:${NC}"
            echo "  file://$(pwd)/avatars/index.html"
            echo ""
            echo -e "${CYAN}To open in Termux:${NC}"
            echo "  termux-open avatars/index.html"
            echo ""
            echo -e "${YELLOW}Quick commands:${NC}"
            echo "  ns nft        - Regenerate all avatars"
            echo "  ns qr [id]    - View QR data for citizen"
            echo "  ls avatars/   - List all avatars"
            
        else
            echo -e "${YELLOW}üé® No avatar gallery found.${NC}"
            echo ""
            echo -e "${CYAN}Generate your first avatar collection:${NC}"
            echo "  ns nft"
        fi
        ;;
    
    verify)
        header
        if [ -z "$2" ]; then
            echo -e "${RED}Usage: ns verify [avatar_file.svg]${NC}"
            echo -e "${YELLOW}Example: ns verify avatars/Heir_Successor_99.svg${NC}"
            exit 1
        fi
        
        if [ ! -f "$2" ]; then
            echo -e "${RED}‚ùå File not found: $2${NC}"
            exit 1
        fi
        
        echo -e "${GREEN}üîç Verifying NeuroSphere Avatar...${NC}"
        echo -e "File: $2"
        echo ""
        
        # Check if it's a valid SVG with NeuroSphere signature
        if grep -q "NeuroSphere" "$2" 2>/dev/null; then
            echo -e "‚úÖ ${GREEN}Valid NeuroSphere Avatar${NC}"
            
            # Extract citizen ID from filename
            CITIZEN_ID=$(basename "$2" .svg | tr '_' ' ')
            
            # Try to get data from database
            DATA=$(sqlite3 "$DB_FILE" "SELECT id, CAST(current_aura * 0.9 AS INTEGER), status FROM citizens WHERE id='$CITIZEN_ID' OR id='${CITIZEN_ID//_/ }';" 2>/dev/null)
            
            if [ -n "$DATA" ]; then
                IFS='|' read -r id aura status <<< "$DATA"
                echo -e "üìã ${CYAN}Database Match Found:${NC}"
                echo -e "   ID: $id"
                echo -e "   Aura: $aura"
                echo -e "   Status: $status"
                
                # Check aura color matches
                if [ "$aura" -le 30 ] && grep -q "#00ff00" "$2"; then
                    echo -e "üé® ${GREEN}Aura color (üå± Seed) matches avatar${NC}"
                elif [ "$aura" -le 70 ] && grep -q "#00ffff" "$2"; then
                    echo -e "üé® ${CYAN}Aura color (üõ°Ô∏è Guardian) matches avatar${NC}"
                elif [ "$aura" -gt 70 ] && grep -q "#ff00ff" "$2"; then
                    echo -e "üé® ${MAGENTA}Aura color (üëë Legend) matches avatar${NC}"
                else
                    echo -e "‚ö†Ô∏è ${YELLOW}Aura color may not match database${NC}"
                fi
            else
                echo -e "‚ö†Ô∏è ${YELLOW}No database entry found for this citizen${NC}"
            fi
            
            echo ""
            echo -e "${GREEN}‚úÖ Verification complete!${NC}"
            echo -e "${CYAN}This avatar contains a scannable QR code with embedded data.${NC}"
            
        else
            echo -e "${RED}‚ùå Not a valid NeuroSphere Avatar${NC}"
            echo "This file doesn't appear to be a NeuroSphere-generated avatar."
        fi
        ;;
    
    reward|inherit|status|rank|list|search|audit|dashboard|backup|version|help)
        # Pass through to old script
        if [ -f "$OLD_SCRIPT" ] && [ -x "$OLD_SCRIPT" ]; then
            # For reward and inherit, generate avatar afterwards
            if [ "$1" = "reward" ] || [ "$1" = "inherit" ]; then
                "$OLD_SCRIPT" "$@"
                RESULT=$?
                
                # If successful and we have an ID, update avatar
                if [ $RESULT -eq 0 ] && [ -n "$2" ] && [ -f "neuro-gen.py" ]; then
                    echo ""
                    echo -e "${CYAN}üîÑ Updating avatar for $2...${NC}"
                    
                    # Get updated data
                    DATA=$(sqlite3 "$DB_FILE" "SELECT id, CAST(current_aura * 0.9 AS INTEGER), status, inherited_from FROM citizens WHERE id='$2';" 2>/dev/null)
                    if [ -n "$DATA" ]; then
                        IFS='|' read -r id aura status inherited <<< "$DATA"
                        python3 -c "
import sys
sys.path.insert(0, '.')
try:
    from neuro_gen import generate_svg
    generate_svg('$id', $aura, '$status', ${inherited:+'$inherited'})
    print('‚úÖ Avatar updated!')
except ImportError:
    # Fallback to full regeneration
    import subprocess
    subprocess.run(['python3', 'neuro-gen.py'], capture_output=True)
" 2>/dev/null || python3 neuro-gen.py 2>/dev/null
                        
                        echo -e "${GREEN}‚úÖ Avatar synchronized!${NC}"
                    fi
                fi
            else
                "$OLD_SCRIPT" "$@"
            fi
        else
            echo -e "${RED}‚ùå Core functionality not available!${NC}"
            echo "Please ensure neuro-old exists and is executable."
            exit 1
        fi
        ;;
    
    *)
        header
        echo -e "${YELLOW}Available Commands:${NC}"
        echo ""
        echo -e "  ${PURPLE}üé® NFT Avatar System (v4.3.0):${NC}"
        echo -e "    nft                 - Generate NFT avatars with QR codes"
        echo -e "    qr [citizen_id]     - Show QR data for citizen"
        echo -e "    gallery             - View avatar collection"
        echo -e "    verify [file.svg]   - Verify avatar authenticity"
        echo ""
        echo -e "  ${CYAN}Core Commands (v4.1.0):${NC}"
        echo -e "    status [id]         - System/citizen status"
        echo -e "    reward id act qty   - Grant LUV (0-10 per action)"
        echo -e "    rank id             - Check citizen's rank"
        echo -e "    inherit owner heir  - Transfer 50% aura"
        echo -e "    search pattern      - Search citizens"
        echo -e "    list [limit]       - List citizens by aura"
        echo -e "    audit              - System audit"
        echo -e "    dashboard          - Live dashboard"
        echo -e "    backup             - Create backup"
        echo -e "    version            - Show version"
        echo -e "    help               - This help"
        echo ""
        echo -e "${MAGENTA}Examples:${NC}"
        echo -e "  ns nft                    # Generate all avatars"
        echo -e "  ns reward Alex Teaching 5 # Reward & auto-update avatar"
        echo -e "  ns qr Alex               # Show QR data"
        echo -e "  ns gallery               # View collection"
        echo -e "  termux-open avatars/index.html # Open in browser"
        echo ""
        echo -e "${GREEN}üì± QR Codes contain:${NC} Citizen ID, Aura, Status, Timestamp"
        ;;
esac
