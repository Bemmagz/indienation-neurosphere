#!/data/data/com.termux/files/usr/bin/bash

VERSION="4.0.1"
DB_FILE="neurosphere.db"

# Colors
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
RED='\033[0;31m'
NC='\033[0m'

header() { echo -e "${CYAN}--- NEUROSPHERE SOVEREIGN SYSTEM v${VERSION} ---${NC}"; }

case "$1" in
    status)
        header
        if [ -z "$2" ] || [ "$2" == "summary" ]; then
            sqlite3 "$DB_FILE" -header -column "SELECT (SELECT COUNT(*) FROM citizens WHERE status='active') as 'Active', (SELECT COUNT(*) FROM citizens WHERE status='inherited') as 'Legacy', (SELECT SUM(current_aura) FROM citizens) as 'Total Aura';"
        else
            sqlite3 "$DB_FILE" -header -column "SELECT id as 'Citizen_ID', current_aura as 'Aura', status as 'Status', inherited_from as 'Source' FROM citizens WHERE id='$2';"
        fi
        ;;
    reward)
        ID=$2; ACT=$3; QTY=$4
        if [ "$QTY" -gt 10 ]; then echo -e "${RED}‚ö†Ô∏è Limit 10!${NC}"; exit 1; fi
        sqlite3 "$DB_FILE" "BEGIN TRANSACTION; UPDATE citizens SET current_aura = current_aura + $QTY WHERE id='$ID'; INSERT INTO kindness_actions (citizen_id, action, coins) VALUES ('$ID', '$ACT', $QTY); COMMIT;"
        echo -e "${GREEN}‚úÖ Reward +$QTY LUV to $ID${NC}"
        ;;
    rank)
        header
        AURA=$(sqlite3 "$DB_FILE" "SELECT current_aura FROM citizens WHERE id='$2';")
        if [ "$AURA" -le 30 ]; then R="üå± Seed"; C=$GREEN; elif [ "$AURA" -le 70 ]; then R="üõ°Ô∏è Guardian"; C=$CYAN; else R="üëë Legend"; C=$MAGENTA; fi
        echo -e "ID: $2 | Aura: $AURA | Rank: ${C}${R}${NC}"
        ;;
    inherit)
        OWNER=$2; HEIR=$3
        AURA=$(sqlite3 "$DB_FILE" "SELECT current_aura FROM citizens WHERE id='$OWNER' AND status='active';")
        if [ -z "$AURA" ]; then echo "‚ùå Owner invalid"; exit 1; fi
        VAL=$((AURA / 2))
        sqlite3 "$DB_FILE" "BEGIN TRANSACTION; UPDATE citizens SET status='inherited' WHERE id='$OWNER'; INSERT OR REPLACE INTO citizens (id, current_aura, status, inherited_from) VALUES ('$HEIR', $VAL, 'active', '$OWNER'); INSERT INTO inheritance_records (owner_id, heir_id, aura_transferred) VALUES ('$OWNER', '$HEIR', $VAL); COMMIT;"
        echo -e "${MAGENTA}üìú Legacy Transferred: $VAL Aura to $HEIR${NC}"
        ;;
    list)
        sqlite3 "$DB_FILE" -header -column "SELECT id, current_aura, status FROM citizens ORDER BY current_aura DESC LIMIT ${2:-10};"
        ;;
    dashboard)
        while true; do
            clear; header
            sqlite3 "$DB_FILE" -header -column "SELECT id, current_aura, status FROM citizens ORDER BY current_aura DESC LIMIT 5;"
            echo -e "\n${YELLOW}Latest Actions:${NC}"
            sqlite3 "$DB_FILE" -header -column "SELECT timestamp, action, coins FROM kindness_actions ORDER BY timestamp DESC LIMIT 3;"
            echo -e "\nCtrl+C to exit..."
            sleep 3
        done
        ;;
    backup)
        mkdir -p backups && cp "$DB_FILE" "backups/ns_$(date +%Y%m%d_%H%M%S).db"
        echo -e "${GREEN}‚úÖ Backup Created${NC}"
        ;;
    version) echo "NeuroSphere CLI v$VERSION" ;;
    *) echo "Commands: status, reward, rank, inherit, list, dashboard, backup, version" ;;
esac
