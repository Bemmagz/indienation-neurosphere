#!/data/data/com.termux/files/usr/bin/bash

# ==========================================================
# üß† NEUROSPHERE UNIFIED CLI v4.0.0
# Core Sovereign Management System (SQL Edition)
# ==========================================================

VERSION="4.0.0"
DB_FILE="neurosphere.db"

# Colors for Auralang
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
MAGENTA='\033[0;35m'
RED='\033[0;31m'
NC='\033[0m'

# Initialize DB if missing
if [ ! -f "$DB_FILE" ]; then
    sqlite3 "$DB_FILE" "CREATE TABLE IF NOT EXISTS citizens (id TEXT PRIMARY KEY, current_aura INTEGER, status TEXT, inherited_from TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP);"
    sqlite3 "$DB_FILE" "CREATE TABLE IF NOT EXISTS kindness_actions (id INTEGER PRIMARY KEY AUTOINCREMENT, citizen_id TEXT, action TEXT, coins INTEGER, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP);"
    sqlite3 "$DB_FILE" "CREATE TABLE IF NOT EXISTS inheritance_records (id INTEGER PRIMARY KEY AUTOINCREMENT, owner_id TEXT, heir_id TEXT, aura_transferred INTEGER, executed_at DATETIME DEFAULT CURRENT_TIMESTAMP);"
fi

header() {
    echo -e "${CYAN}--- NEUROSPHERE SOVEREIGN SYSTEM v${VERSION} ---${NC}"
}

case "$1" in
    status)
        header
        if [ -z "$2" ] || [ "$2" == "summary" ]; then
            sqlite3 "$DB_FILE" -header -column "SELECT (SELECT COUNT(*) FROM citizens WHERE status='active') as 'Active', (SELECT COUNT(*) FROM citizens WHERE status='inherited') as 'Legacy', (SELECT SUM(current_aura) FROM citizens) as 'Total Aura';"
        else
            sqlite3 "$DB_FILE" -header -column "SELECT id as 'Citizen_ID', current_aura as 'Aura', status as 'Status', inherited_from as 'Source' FROM citizens WHERE id='$2';"
        fi
        ;;
    reward)
        # E-KINDNESS Algorithm: 0-10 coins per day
        ID=$2; ACT=$3; QTY=$4
        if [ -z "$QTY" ]; then echo "Usage: ns reward [ID] [ACTION] [0-10]"; exit 1; fi
        if [ "$QTY" -gt 10 ]; then echo -e "${RED}‚ö†Ô∏è E-KINDNESS Limit exceeded (Max 10 per action)${NC}"; exit 1; fi
        
        sqlite3 "$DB_FILE" "BEGIN TRANSACTION; UPDATE citizens SET current_aura = current_aura + $QTY WHERE id='$ID'; INSERT INTO kindness_actions (citizen_id, action, coins) VALUES ('$ID', '$ACT', $QTY); COMMIT;"
        echo -e "${GREEN}‚úÖ Reward +$QTY LUV successfully granted to $ID for $ACT.${NC}"
        ;;
    rank)
        header
        AURA=$(sqlite3 "$DB_FILE" "SELECT current_aura FROM citizens WHERE id='$2';")
        if [ -z "$AURA" ]; then echo "Citizen not found."; exit 1; fi
        if [ "$AURA" -le 30 ]; then R="üå± Seed"; C=$GREEN; elif [ "$AURA" -le 70 ]; then R="üõ°Ô∏è Guardian"; C=$CYAN; else R="üëë Legend"; C=$MAGENTA; fi
        echo -e "ID: $2 | Aura: $AURA | Rank: ${C}${R}${NC}"
        ;;
    list)
        sqlite3 "$DB_FILE" -header -column "SELECT id, current_aura, status FROM citizens ORDER BY current_aura DESC LIMIT ${2:-10};"
        ;;
    dashboard)
        while true; do
            clear; header
            echo -e "${YELLOW}Top 5 Sovereign Identities:${NC}"
            sqlite3 "$DB_FILE" -header -column "SELECT id, current_aura, status FROM citizens ORDER BY current_aura DESC LIMIT 5;"
            echo -e "\n${YELLOW}Latest Actions:${NC}"
            sqlite3 "$DB_FILE" -header -column "SELECT timestamp, citizen_id, action, coins FROM kindness_actions ORDER BY timestamp DESC LIMIT 3;"
            echo -e "\nPress Ctrl+C to exit dashboard..."
            sleep 3
        done
        ;;
    version)
        echo "NeuroSphere Unified CLI v$VERSION"
        ;;
    *)
        echo -e "Available Commands: status, reward, rank, list, dashboard, version"
        ;;
esac
    inherit)
        if [ -z "$2" ] || [ -z "$3" ]; then 
            echo "Usage: neuro inherit <owner_id> <heir_id>"
            echo "Example: neuro inherit Citizen_77 Heir_Successor_99"
            exit 1
        fi
        
        # Check if owner exists and has sufficient aura
        OWNER_AURA=$(sqlite3 "$DB_FILE" "SELECT current_aura FROM citizens WHERE id='$2';")
        if [ -z "$OWNER_AURA" ]; then
            echo -e "${RED}‚ùå Owner '$2' not found.${NC}"
            exit 1
        fi
        
        if [ "$OWNER_AURA" -lt 50 ]; then
            echo -e "${RED}‚ùå Insufficient aura for inheritance (minimum 50 required).${NC}"
            exit 1
        fi
        
        # Calculate inheritance (50% transfer)
        TRANSFER=$((OWNER_AURA / 2))
        
        # Execute inheritance
        sqlite3 "$DB_FILE" << EOF_SQL
BEGIN TRANSACTION;
-- Reduce owner's aura
UPDATE citizens SET current_aura = current_aura - $TRANSFER WHERE id='$2';
-- Create or update heir
INSERT OR REPLACE INTO citizens (id, current_aura, status, inherited_from) 
VALUES ('$3', $TRANSFER, 'inherited', '$2');
-- Record the inheritance
INSERT INTO inheritance_records (owner_id, heir_id, aura_transferred) 
VALUES ('$2', '$3', $TRANSFER);
COMMIT;
EOF_SQL
        
        echo -e "${GREEN}‚úÖ Inheritance successful!${NC}"
        echo -e "Owner: $2 (Aura: $((OWNER_AURA - TRANSFER)))"
        echo -e "Heir: $3 (Aura: $TRANSFER) ${MAGENTA}[INHERITED]${NC}"
        ;;
    
    search)
        if [ -z "$2" ]; then
            echo "Usage: neuro search <pattern>"
            echo "Searches citizen IDs and statuses"
            exit 1
        fi
        
        sqlite3 "$DB_FILE" -header -column << EOF_SQL
SELECT 
    id as "Citizen ID", 
    current_aura as "Aura",
    CASE 
        WHEN current_aura <= 30 THEN '${GREEN}üå± Seed${NC}'
        WHEN current_aura <= 70 THEN '${CYAN}üõ°Ô∏è Guardian${NC}'
        ELSE '${MAGENTA}üëë Legend${NC}'
    END as "Rank",
    status as "Status"
FROM citizens 
WHERE id LIKE '%$2%' OR status LIKE '%$2%'
ORDER BY current_aura DESC;
EOF_SQL
        ;;
    
    audit)
        header
        echo -e "${YELLOW}üìä SYSTEM AUDIT REPORT${NC}"
        echo "========================="
        
        # Basic stats
        TOTAL_CITIZENS=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM citizens;")
        ACTIVE_CITIZENS=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM citizens WHERE status='active';")
        LEGACY_CITIZENS=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM citizens WHERE status='inherited';")
        TOTAL_AURA=$(sqlite3 "$DB_FILE" "SELECT SUM(current_aura) FROM citizens;")
        TOTAL_ACTIONS=$(sqlite3 "$DB_FILE" "SELECT COUNT(*) FROM kindness_actions;")
        TOTAL_COINS=$(sqlite3 "$DB_FILE" "SELECT SUM(coins) FROM kindness_actions;")
        
        echo -e "${CYAN}Population:${NC}"
        echo -e "  Total Citizens: $TOTAL_CITIZENS"
        echo -e "  Active: $ACTIVE_CITIZENS"
        echo -e "  Legacy/Inherited: $LEGACY_CITIZENS"
        echo -e "  Total Aura in System: $TOTAL_AURA"
        echo ""
        
        echo -e "${CYAN}Kindness Economy:${NC}"
        echo -e "  Total Actions: $TOTAL_ACTIONS"
        echo -e "  Total Coins Distributed: $TOTAL_COINS"
        echo ""
        
        echo -e "${CYAN}Top 5 Contributors:${NC}"
        sqlite3 "$DB_FILE" -header -column << EOF_SQL
SELECT 
    citizen_id as "Citizen",
    COUNT(*) as "Actions",
    SUM(coins) as "Total Coins",
    AVG(coins) as "Avg Per Action"
FROM kindness_actions 
GROUP BY citizen_id 
ORDER BY SUM(coins) DESC 
LIMIT 5;
EOF_SQL
        echo ""
        
        echo -e "${CYAN}Recent Inheritance Records:${NC}"
        sqlite3 "$DB_FILE" -header -column << EOF_SQL
SELECT 
    owner_id as "From",
    heir_id as "To", 
    aura_transferred as "Aura",
    executed_at as "Date"
FROM inheritance_records 
ORDER BY executed_at DESC 
LIMIT 3;
EOF_SQL
        ;;
    
    backup)
        BACKUP_DIR="backups"
        mkdir -p "$BACKUP_DIR"
        BACKUP_FILE="$BACKUP_DIR/neurosphere_backup_$(date +%Y%m%d_%H%M%S).db"
        
        # Create backup
        cp "$DB_FILE" "$BACKUP_FILE"
        
        # Compress backup
        gzip -f "$BACKUP_FILE" 2>/dev/null || true
        
        echo -e "${GREEN}‚úÖ Backup created successfully!${NC}"
        echo -e "Location: $BACKUP_FILE.gz"
        echo -e "Size: $(du -h "$BACKUP_FILE.gz" 2>/dev/null || echo "Compressed")"
        echo ""
        
        # List recent backups
        echo -e "${YELLOW}Recent backups:${NC}"
        ls -lh "$BACKUP_DIR"/*.db.gz 2>/dev/null | tail -5 || echo "No previous backups found."
        ;;
    
    help)
        header
        echo -e "${YELLOW}Available Commands:${NC}"
        echo ""
        echo -e "  ${GREEN}status${NC} [citizen_id]     - Show system or citizen status"
        echo -e "  ${GREEN}reward${NC} <id> <act> <qty> - Grant LUV coins (0-10 per action)"
        echo -e "  ${GREEN}rank${NC} <citizen_id>      - Check citizen's rank with Auralang colors"
        echo -e "  ${GREEN}list${NC} [limit]          - List citizens by aura (default: 10)"
        echo -e "  ${GREEN}inherit${NC} <from> <to>   - Transfer 50% aura to heir"
        echo -e "  ${GREEN}search${NC} <pattern>      - Search citizens by ID or status"
        echo -e "  ${GREEN}dashboard${NC}             - Live system dashboard"
        echo -e "  ${GREEN}audit${NC}                 - Comprehensive system audit"
        echo -e "  ${GREEN}backup${NC}                - Create database backup"
        echo -e "  ${GREEN}version${NC}               - Show CLI version"
        echo -e "  ${GREEN}help${NC}                  - This help message"
        echo ""
        echo -e "${MAGENTA}Auralang Ranks:${NC}"
        echo -e "  ${GREEN}üå± Seed${NC}      : 0-30 aura"
        echo -e "  ${CYAN}üõ°Ô∏è Guardian${NC} : 31-70 aura"
        echo -e "  ${MAGENTA}üëë Legend${NC}   : 71+ aura"
        ;;
